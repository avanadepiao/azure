# Virtual Machine Scale Sets - Windows

同じイメージから複数のVMを作成し、アプリケーションの複数のインスタンスを持つことができますが、それらはすべて個別のVMであり、独自のIPアドレスとPIPを持っています。複数のVMインスタンスが必要な場合、Virtual Machine Scale Set（VMSS）を使用できます。これにより、単一のリソースから複数のVMを管理できます。

このラボでは、既存のアプリケーションイメージを使用して、WindowsアプリケーションのためのVMSSを作成します。

## 参照情報 

- [Virtual Machine Scale Sets の概要](https://learn.microsoft.com/en-gb/azure/virtual-machine-scale-sets/overview)

- [カスタム イメージを使用して VMSS を作成する](https://learn.microsoft.com/en-gb/azure/virtual-machine-scale-sets/tutorial-use-custom-image-cli)

- [`az vmss` コマンド](https://learn.microsoft.com/en-us/cli/azure/vmss?view=azure-cli-latest)

## ポータル

まず、ポータルで探索を開始します - 新しいリソースを作成し、VMSSを検索します。Virtual Machine Scale Setを作成するオプションを選択します:

- 通常のVM設定があります - イメージ、サイズ、およびディスク
- [Orchestration mode](https://learn.microsoft.com/en-gb/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-orchestration-modes)を選択できます。最も一般的なのはuniformです。
- _Scaling_ セクションで、スケール セット内のVMインスタンスの数を選択します。スケーリング ポリシーを_自動スケーリング_に変更し、_スケール アウト_ と _スケール イン_ のしきい値とインスタンスの数が表示されます。

## カスタム イメージからVMSSを作成

[VMイメージの演習](/labs/vm-image/README_jp.md)で使用するためのイメージが準備された、`labs-vmss-win` という名前のRGが作成されている必要があります。



```
az group show -o table -n labs-vmss-win

az image list -o table -g labs-vmss-win
```


> これにより、新しいRGに移動（またはコピー）した `app01-image` が表示されるはずです。表示されない場合は、VMイメージラボの手順を繰り返す必要があります。

📋 `vmss create` コマンドを使用して、VMイメージからスリーインスタンスを持つスケール セットを作成し、RDPポート3389を利用可能にしてVMに接続できるようにします。

<details>
  <summary>わからない場合は？</summary>

コマンドのヘルプを確認してください:



```
az vmss create --help
```


VM SKU、インスタンス数、バックエンド ポート、イメージ、および管理者資格情報を指定する必要があります:


```
# 好きなVMサイズと場所を選択してください：
az vmss create -n vmss-app01 -g labs-vmss-win --vm-sku Standard_D2s_v5 --instance-count 3 --backend-port 3389 --image app01-image --admin-username labs --admin-password '<strong-password>' -l southeastasia
```


</details><br/>

VMSSが作成されたら、RG内のVMリストを確認します：



```
az vm list -o table -g labs-vmss-win 
```

> 個別のVMはありません、VMSSを介してインスタンスを管理します

ポータルでVMSSを開きます:

- リソース グループを開きます - イメージ以外にどのリソースがありますか？

- vmssを開き、_インスタンス_ ブレードを確認します - 3つのインスタンスが表示され、異なるステータス（Running、Updating）になっているかもしれません。また、連続した番号ではないかもしれません。

- VMSSのインスタンスを1つクリックします - プライベートIPアドレスはありますが、パブリックIPアドレスはありません

- RGに戻ると、パブリックIPアドレスがあることがわかります - それが_ロードバランサー_ に関連していることが表示されます

> パブリックIPアドレスに移動してアプリが応答するかどうかを確認してください

いいえ、まだです :)

## ロードバランサーの設定

VMSSを作成すると、ネットワーキングコンポーネントであるロードバランサーも設定されます。ロードバランサーはパブリックIPアドレスで受信トラフィックを待ち、その後、トラフィックをVMSSの1つにルーティングします。

なぜアプリが動作しないのでしょうか？ デフォルトではVMSSのセットアップにロードバランシングルールが含まれていないためです。したがって、LBにはルーティングテーブルがなく、トラフィックを送信する場所を知りません。

ポータルでLBを開きます:

- _バックエンド プール_ を選択し、VMSSのインスタンスがすべて存在し、実行中であることを確認します
- _ヘルス プローブ_ を選択します - これはLBがバックエンドプールのリソースがトラフィックを受信できる準備ができているかどうかを確認する方法です。これまでのところプローブはありません
- _ロード バランシング ルール_ を選択します - なし、これがアプリが動作しない理由です。LBはリクエストを受信しますが、バックエンドに転送するルールがありません

📋 フロントエンドPIPで受信し、ポート80を使用してVMSSバックエンドプールにルーティングするルールを追加してください。

<details>
  <summary>わからない場合は？</summary>

ロードバランシングルールを追加して、任意の名前を付けます。次に:

- フロントエンドのPIPを選択します
- バックエンドプールにVMSSを選択します
- ポートおよびバックエンドポートに`80`を入力します
- ヘルスプローブも追加する必要があります - HTTPタイプを選択してください

</details><br/>

ロードバランサーは、健全なエンドポイントにのみトラフィックを送信するため、ヘルスプローブを含める必要があります。

再びPIPにアクセスしてください - これでアプリが表示されるはずです。リフレッシュすると異なるVMからの応答を受け取りますか？

## VMSSのスケーリング

ブラウザスタックには多くのキャッシュがあるため、コマンドラインを使用してPIPにGETリクエストを送信してみてください:



```
curl http://<pip>
```


これを繰り返すと、ロードバランサーが3つのVM間でリクエストを共有するため、HTMLの応答で異なるVM名が表示されるはずです。

📋 `vmss scale` コマンドを使用して、5つのインスタンスにスケーリングアップしてみてください。オンラインになり、応答を提供し始めるまでにどれくらい時間がかかりますか？

<details>
  <summary>わからない場合は？</summary>

ヘルプテキストを確認すると、非常にシンプルなコマンド - 希望する容量を設定するだけです:



```
az vmss scale -g labs-vmss-win -n vmss-app01 --new-capacity 5
```


</details><br/>

ポータルで確認してみてください - VMSSブレードに新しいインスタンスがリストされ、自動的にLBバックエンドプールに追加されます。それらが健全になると、LBの有効なターゲットになります。

> それらは数分で作成されます。Windows VMはLinuxよりも起動に時間がかかります

VMSS内に5つ以上のインスタンスも表示されることがあります - なぜでしょうか？ Azureはオーバープロビジョニングしているためです - VMの起動時間にばらつきがあることを知っているため、必要以上に作成し、希望の数がオンラインになると、スタートアップ中のインスタンスを削除します（これがインスタンス番号が連続していない理由です - 欠落している番号は削除されたものです）。

新しいインスタンスがリクエスト負荷を共有しているのを確認するために、curlコマンドを繰り返して試してみてください:



```
curl http://<pip>
```


手動スケールを使用していますが、自動スケールも設定できます。スケールできる唯一のメトリックはCPUです - インスタンスが過度に稼働していると、VMSSはさらに多くのインスタンスを追加します。十分な作業がない場合、一部のインスタンスが削除されます。

📋 ポータルでVMSSの設定を変更して、最小2つのVMと最大3つのVMを持つようにし、CPUが10％を超える場合にスケールアップし、CPUが8％未満の場合にスケールダウンするようにしてください。タイムスケールは2分に設定して変更を素早く確認します。

<details>
  <summary>わからない場合は？</summary>

- ポータルでVMSSを開き、_スケーリング_ ブレードに移動します
- _カスタムオートスケール_ に切り替えます
- _メトリックに基づいてスケーリング_ を選択します
- 最小2、最大3、デフォルト2を設定します
- スケールアウトするためのルールを追加 - 平均CPUが10％を超える場合、インスタンスを1つ増やす
- スケールインするためのルールを追加 - 平均CPUが8％未満の場合、インスタンスを1つ減らす
- 変更を素早く確認するために2分のタイムスケールを使用します

</details><br/>

VMSSには自動スケールを適用する前に5つのインスタンスがあります。自動スケールを適用した後、インスタンスの数はどうなりますか？スケーリングイベントが進行中の場合、アプリはまだ動作しますか？

数分後、インスタンス2つが削除され、最大3つに減少します。これらの削除中のインスタンスはLBから削除されます。アクティビティがない数分後、さらに1つが削除され、最小2つに減少します。

> 最後に追加されたVMは削除されますか？ VMがリクエストを処理しているときに削除された場合、どうなりますか？

## ラボ

ロードバランサーのヘルスプローブは、多くの障害シナリオを管理するための強力な機能です。インスタンスが健康でない場合、アプリが正しく機能するかどうかをテストする必要があります。VMSSを使用して、リモートデスクトップでインスタンスに接続し、IIS Windowsサービスを停止してWebサーバーをオフラインにします。それを試して、ロードバランサーが期待どおりに動作するか確認してください。ポータルでプローブのステータスを確認できますか？

> 行き詰まっていますか？[ヒント](hints_jp.md)を試してみるか、[ソリューション](solution_jp.md)を確認してみてください。

___

## クリーンアップ

ラボリソース グループを削除して、VMSSも削除します - VMSSが削除されると、すべてのVMも削除されます:



```
az group delete -y -n labs-vmss-win
```
